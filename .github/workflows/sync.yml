name: 强制提取真实节点

on:
  schedule:
    - cron: '*/30 * * * *'
  workflow_dispatch: 

jobs:
  update_link:
    runs-on: ubuntu-latest
    steps:
      - name: 检出仓库
        uses: checkout@v3

      - name: 抓取并深度转换
        run: |
          # 1. Get the latest dynamic URL from README
          RAW_README=$(curl -s https://raw.githubusercontent.com/mksshare/mksshare.github.io/main/README.md)
          DYNAMIC_URL=$(echo "$RAW_README" | grep -oE "https://[a-zA-Z0-9.-]+\.mcsslk\.xyz/[a-zA-Z0-9]+" | head -n 1 | tr -d '\r' | xargs)
          
          if [ -z "$DYNAMIC_URL" ]; then
            echo "Error: URL not found"
            exit 1
          fi

          # 2. Use a powerful Sub-Converter backend to strip out the "maintenance" placeholders
          # This forces the API to return ONLY working nodes
          CONVERT_URL="https://sub.id9.cc/sub?target=clash&url=${DYNAMIC_URL}&insert=false&config=https%3A%2F%2Fraw.githubusercontent.com%2FACL4SSR%2FACL4SSR%2Fmaster%2FClash%2Fconfig%2FACL4SSR_Online.ini&emoji=true&list=false&tfo=false&scv=false&fdn=false&sort=false"
          
          curl -L "$CONVERT_URL" -o config.yaml

      - name: 推送更新
        run: |
          git config --local user.email "actions@github.com"
          git config --local user.name "GitHub Action"
          git add config.yaml
          git commit -m "Force-extracted real nodes: $(date)" || echo "No changes"
          git push
