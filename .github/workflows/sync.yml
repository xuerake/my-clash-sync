name: 自动动态同步订阅

on:
  schedule:
    - cron: '*/30 * * * *'
  workflow_dispatch: 

jobs:
  update_link:
    runs-on: ubuntu-latest
    steps:
      - name: 检出仓库
        uses: actions/checkout@v3

      - name: 动态解析最新链接
        run: |
          # 1. 获取原作者 README 原始文本
          RAW_README=$(curl -s https://raw.githubusercontent.com/mksshare/mksshare.github.io/main/README.md)
          
          # 2. 改进的提取逻辑：直接在全文寻找包含 mcsslk.xyz 的 https 链接
          # 这种方式不依赖行数，只要链接在页面上就能抓到
          DYNAMIC_URL=$(echo "$RAW_README" | grep -oE "https://[a-zA-Z0-9.-]+\.mcsslk\.xyz/[a-zA-Z0-9]+")
          
          echo "捕获到的最新动态链接: $DYNAMIC_URL"
          
          if [ -z "$DYNAMIC_URL" ]; then
            echo "错误：未能解析到动态域名链接"
            exit 1
          fi

          # 3. 下载并存为 config.yaml
          # 注意：直接下载该链接内容。如果导入 Clash 仍无节点，可尝试在 URL 后加 &flag=clash
          curl -L "$DYNAMIC_URL" -H "User-Agent: Clash" -o config.yaml

      - name: 推送更新
        run: |
          git config --local user.email "actions@github.com"
          git config --local user.name "GitHub Action"
          git add config.yaml
          git commit -m "自动同步最新节点: $(date)" || echo "内容无变化"
          git push
