name: å…³é”®è¯å®šä½ç²¾å‡†æŠ“å–

on:
  schedule:
    - cron: '*/30 * * * *'
  workflow_dispatch: 

jobs:
  update_link:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»“åº“
        uses: actions/checkout@v3

      - name: å®šä½å…³é”®è¯å¹¶ä¸‹è½½é…ç½®
        run: |
          # 1. ä¸‹è½½åŸä½œè€… README æºç 
          RAW_README=$(curl -s https://raw.githubusercontent.com/mksshare/mksshare.github.io/main/README.md)
          
          # 2. å®šä½â€œğŸš€å…è´¹Clashè®¢é˜…é“¾æ¥â€æ–‡å­—çš„ä¸‹ä¸€è¡Œï¼Œå¹¶æå– URL
          # ä½¿ç”¨ grep è¿‡æ»¤æ‰å¯èƒ½çš„ HTML æ ‡ç­¾ï¼Œåªå– https å¼€å¤´çš„çº¯é“¾æ¥
          DYNAMIC_URL=$(echo "$RAW_README" | grep -A 1 "ğŸš€å…è´¹Clashè®¢é˜…é“¾æ¥" | grep -oE "https://[a-zA-Z0-9./_-]+")
          
          echo "å®šä½åˆ°çš„åŸå§‹é“¾æ¥ä¸º: $DYNAMIC_URL"
          
          if [ -z "$DYNAMIC_URL" ]; then
            echo "é”™è¯¯ï¼šæ— æ³•æ ¹æ®å…³é”®è¯å®šä½é“¾æ¥"
            exit 1
          fi

          # 3. å…³é”®ï¼šåœ¨é“¾æ¥æœ«å°¾æ·»åŠ  Clash æ ‡å¿—ï¼Œç¡®ä¿è¿”å›çš„æ˜¯å®Œæ•´é…ç½®æ–‡ä»¶
          # å¦‚æœåŸé“¾æ¥å·²å¸¦å‚æ•°å°±ç”¨ &ï¼Œæ²¡å¸¦å°±ç”¨ ?
          if [[ "$DYNAMIC_URL" == *"?"* ]]; then
            FINAL_URL="${DYNAMIC_URL}&flag=clash"
          else
            FINAL_URL="${DYNAMIC_URL}?flag=clash"
          fi

          # 4. ä¸‹è½½å†…å®¹å¹¶å­˜ä¸º config.yaml
          curl -L "$FINAL_URL" -H "User-Agent: Clash" -o config.yaml

      - name: æ¨é€æ›´æ–°
        run: |
          git config --local user.email "actions@github.com"
          git config --local user.name "GitHub Action"
          git add config.yaml
          git commit -m "åŒæ­¥åŠ¨æ€èŠ‚ç‚¹: $(date)" || echo "å†…å®¹æ— å˜åŒ–"
          git push
