name: 动态链接跳转更新

on:
  schedule:
    - cron: '*/30 * * * *'
  workflow_dispatch: 

jobs:
  update_redirect:
    runs-on: ubuntu-latest
    steps:
      - name: 检出仓库
        uses: actions/checkout@v3

      - name: 抓取并生成跳转页
        run: |
          # 1. 获取原作者最新的动态链接
          RAW_README=$(curl -s https://raw.githubusercontent.com/mksshare/mksshare.github.io/main/README.md)
          DYNAMIC_URL=$(echo "$RAW_README" | grep -oE "https://[a-zA-Z0-9.-]+\.mcsslk\.xyz/[a-zA-Z0-9]+" | head -n 1 | tr -d '\r' | xargs)
          
          echo "捕获到的链接: $DYNAMIC_URL"
          
          if [ -z "$DYNAMIC_URL" ]; then
            echo "未能获取链接，跳过更新"
            exit 1
          fi

          # 2. 生成一个 HTML 自动跳转文件
          # 当你访问 https://你的用户名.github.io/my-clash-sync/ 时，它会自动跳到订阅链接
          cat <<EOF > index.html
          <!DOCTYPE html>
          <html>
          <head>
            <meta http-equiv="refresh" content="0;url=${DYNAMIC_URL}">
          </head>
          <body>
            <p>正在跳转到最新订阅: <a href="${DYNAMIC_URL}">${DYNAMIC_URL}</a></p>
          </body>
          </html>
          EOF

          # 3. 同时保存一份纯文本备用
          echo "$DYNAMIC_URL" > link.txt

      - name: 推送更新
        run: |
          git config --local user.email "actions@github.com"
          git config --local user.name "GitHub Action"
          git add index.html link.txt
          git commit -m "更新动态跳转地址: $(date)" || echo "无变化"
          git push
