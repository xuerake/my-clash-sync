name: 半小时自动更新订阅

on:
  schedule:
    # 每 30 分钟运行一次 (UTC 时间 0, 30)
    - cron: '*/30 * * * *'
  workflow_dispatch: # 允许你手动点击按钮运行

jobs:
  update_link:
    runs-on: ubuntu-latest
    steps:
      - name: 检出仓库代码
        uses: actions/checkout@v3

      - name: 抓取并提取最新的 Clash 链接
        run: |
          # 1. 获取目标页面的源码
          # 2. 这里的正则会寻找包含 clash.yaml 的 https 链接
          # 3. 如果对方页面格式变动，可能需要微调 grep 后的匹配规则
          LATEST_URL=$(curl -s https://raw.githubusercontent.com/mksshare/mksshare.github.io/main/README.md | grep -o 'https://[^"]*clash.yaml' | head -n 1)
          
          echo "获取到的最新链接为: $LATEST_URL"
          
          # 下载该链接的内容并保存为本地文件
          if [ -n "$LATEST_URL" ]; then
            curl -L "$LATEST_URL" -o config.yaml
          else
            echo "抓取失败，未找到有效链接"
            exit 1
          fi

      - name: 推送到我的仓库
        run: |
          git config --local user.email "actions@github.com"
          git config --local user.name "GitHub Action"
          git add config.yaml
          git commit -m "自动更新订阅: $(date)" || echo "内容无变化，跳过提交"
          git push
